<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 劇本初步分析 - 劇沙成塔</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 基礎 CSS (與 index.html 保持一致) --- */
        :root { --primary-brown: #5D4037; --sand-gold: #C5A065; --warm-white: #FAF9F6; --card-bg: rgba(255, 253, 245, 0.95); --border-color: #E0D0B0; }
        body { margin: 0; padding: 0; font-family: "Helvetica Neue", Helvetica, Arial, "Microsoft JhengHei", sans-serif; min-height: 100vh; color: var(--primary-brown); background-image: url('background.png'); background-position: center bottom; background-repeat: no-repeat; background-size: cover; background-attachment: fixed; overflow-x: hidden; }
        
        /* Header & Sidebar */
        header { position: fixed; top: 0; left: 0; width: 100%; height: 100px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; border-bottom: 2px solid var(--border-color); z-index: 1000; }
        .menu-btn { font-size: 24px; cursor: pointer; padding: 10px; border: 1px solid var(--border-color); color: var(--primary-brown); width: 50px; text-align: center; transition: 0.3s; }
        .menu-btn:hover { background-color: var(--warm-white); }
        .logo-section { font-size: 28px; font-weight: bold; letter-spacing: 2px; text-align: center; border: 2px solid var(--primary-brown); padding: 10px 40px; background: #fff; color: var(--primary-brown); position: absolute; left: 50%; transform: translateX(-50%); }
        .right-section { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 15px; }
        .login-btn { text-decoration: none; color: var(--primary-brown); font-weight: bold; border: 1px solid var(--border-color); padding: 5px 20px; background: #fff; display: inline-block; font-size: 14px; transition: 0.3s; cursor: pointer; }
        .login-btn:hover { background-color: var(--sand-gold); color: #fff; }
        .member-menu { font-size: 14px; font-weight: bold; color: var(--primary-brown); }
        .member-link { cursor: pointer; color: var(--primary-brown); text-decoration: none; transition: 0.3s; }
        .member-link:hover { color: var(--sand-gold); }
        .divider { margin: 0 8px; color: #ccc; }
        .search-container input { padding: 5px 10px; border: 1px solid var(--border-color); font-size: 14px; width: 250px; outline: none; background-color: #fff; }
        
        .sidebar { height: 100%; width: 250px; position: fixed; z-index: 2000; top: 0; left: -250px; background-color: var(--warm-white); border-right: 1px solid var(--border-color); overflow-x: hidden; transition: 0.3s; padding-top: 60px; box-shadow: 2px 0 5px rgba(93, 64, 55, 0.1); }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 18px; color: var(--primary-brown); display: block; transition: 0.3s; border-bottom: 1px solid #eee; }
        .sidebar a:hover { background-color: #f1f1f1; color: var(--sand-gold); }
        .sidebar .close-btn { position: absolute; top: 10px; right: 25px; font-size: 36px; border: none; background: none; cursor: pointer; color: var(--primary-brown); }
        #overlay { position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(93, 64, 55, 0.4); z-index: 1500; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-top: 5px solid var(--sand-gold); animation: slideIn 0.3s ease-out; }
        .modal-box.wide { max-width: 800px; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; transition: 0.2s; }
        .modal-close-btn:hover { color: var(--primary-brown); }
        .login-form input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-submit-btn { width: 100%; padding: 10px; background-color: var(--primary-brown); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .manage-section { margin-bottom: 30px; }
        .manage-section h3 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; color: var(--primary-brown); margin-top: 0; }
        .script-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .script-table th, .script-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .script-table th { background-color: var(--warm-white); color: var(--sand-gold); }
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .tag-yes { background-color: #E8F5E9; color: #2E7D32; }

        /* 本頁專屬樣式 */
        main { padding-top: 150px; max-width: 1300px; margin: 0 auto; padding-bottom: 100px; padding-left: 20px; padding-right: 20px;}
        
        .analysis-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 20px; margin-bottom: 30px; }

        /* 輸入區 */
        .input-panel { background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(93, 64, 55, 0.08); display: flex; flex-direction: column; }
        .input-area { width: 100%; height: 400px; margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; box-sizing: border-box; resize: vertical; }
        
        .settings-group { background-color: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .settings-label { font-size: 0.9rem; color: var(--primary-brown); font-weight: bold; margin-bottom: 5px; display: block; }
        .api-input, .model-select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: monospace; color: #333; font-size: 0.95rem; }
        .model-select { cursor: pointer; }

        .btn-analyze { background-color: var(--primary-brown); color: white; border: none; padding: 15px; border-radius: 5px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-analyze:hover { background-color: #4e342e; }
        .btn-analyze.loading { background-color: #999; cursor: not-allowed; }
        .btn-auto-detect { background-color: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin-top: 5px; display: inline-block; }
        .btn-auto-detect:hover { background-color: #1976D2; }

        /* 結果區 */
        .result-panel { display: flex; flex-direction: column; gap: 20px; }
        .result-card { background: #fff; padding: 20px; border-radius: 10px; border-left: 5px solid var(--sand-gold); box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .result-title { font-size: 1.1rem; color: var(--primary-brown); margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .result-content { font-size: 1rem; color: #555; line-height: 1.6; }

        /* 圖表區 */
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .chart-box { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(93, 64, 55, 0.05); }
        .full-width { grid-column: 1 / -1; }

        .world-box-office { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .continent-card { background: #fdfdfd; border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 8px; transition: 0.3s; }
        .continent-card:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); border-color: var(--sand-gold); }
        .cont-name { font-weight: bold; color: var(--primary-brown); display: block; margin-bottom: 5px; }
        .cont-money { color: #2E7D32; font-weight: bold; font-size: 1.1rem; }
        .cont-age { font-size: 0.85rem; color: #888; margin-top: 5px; display: block; }

        @media screen and (max-width: 900px) {
            .analysis-container { grid-template-columns: 1fr; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="overlay" onclick="toggleNav()"></div>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="close-btn" onclick="toggleNav()">&times;</a>
        <a href="index.html">首頁</a>
        <a href="Scriptupload.html">劇本上傳SATA</a>
        <a href="ai_analysis.html" style="color: var(--sand-gold); font-weight: bold;">AI 劇本初步分析</a>
        <a href="script_database.html">SATA劇本資料庫</a>
        <a href="#">專業諮詢服務</a>
    </div>

    <div id="loginModal" class="modal-overlay"><div class="modal-box"><div class="modal-close-btn" onclick="toggleLoginModal()"><i class="fas fa-times"></i></div><h2 style="text-align: center; color: var(--primary-brown); margin-top: 0;">會員登入</h2><div class="login-form"><input type="text" id="username" placeholder="帳號 (預設: 123456)" value="123456"><input type="password" id="password" placeholder="密碼 (預設: 123456)" value="123456"><button class="login-submit-btn" onclick="performLogin()">登入</button></div></div></div>
    <div id="memberModal" class="modal-overlay"><div class="modal-box wide"><div class="modal-close-btn" onclick="toggleMemberModal()"><i class="fas fa-times"></i></div><h2 style="text-align: center; color: var(--primary-brown); margin-top: 0;">會員管理中心</h2><div class="manage-section"><h3><i class="fas fa-book"></i> 劇本管理</h3><table class="script-table"><thead><tr><th>劇本名稱</th><th>點閱累積</th><th>潛在投資者</th></tr></thead><tbody><tr><td>《我的模擬劇本A》</td><td>80 次</td><td><span class="status-tag tag-yes">有</span></td></tr></tbody></table></div><div class="manage-section"><h3><i class="fas fa-hand-holding-usd"></i> 投資意願管理</h3><table class="script-table"><thead><tr><th>劇本名稱</th><th>類型</th><th>狀態</th></tr></thead><tbody id="investment-table-body"></tbody></table></div></div></div>

    <header>
        <div class="menu-btn" onclick="toggleNav()"><i class="fas fa-bars"></i></div>
        <div class="logo-section">劇沙成塔</div>
        <div class="right-section">
            <div id="headerRightSection"><a href="javascript:void(0)" class="login-btn" onclick="toggleLoginModal()">登入</a></div>
            <div class="search-container"><input type="text" placeholder="請輸入劇本名稱/編劇名稱"></div>
        </div>
    </header>

    <main>
        <h1 style="text-align: center; margin-bottom: 30px;">AI 劇本初步分析</h1>

        <div class="analysis-container">
            <div class="input-panel">
                <h3 style="margin-top:0; color:var(--primary-brown);">1. 輸入劇本內容</h3>
                <textarea id="scriptInput" class="input-area" placeholder="請在此貼上您的劇本大綱或片段..."></textarea>
                
                <div class="settings-group">
                    <label class="settings-label"><i class="fas fa-key"></i> Google Gemini API Key:</label>
                    <input type="password" id="apiKeyInput" class="api-input" placeholder="若留空則使用模擬數據">
                    
                    <label class="settings-label"><i class="fas fa-robot"></i> 選擇 AI 模型版本:</label>
                    <select id="modelSelect" class="model-select">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (最新預覽)</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (最新預覽)</option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (實驗版)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (標準)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (進階)</option>
                        <option value="custom">手動輸入模型名稱...</option>
                    </select>
                    <input type="text" id="customModelInput" class="api-input" style="display:none;" placeholder="例如: gemini-1.0-pro">
                    
                    <button type="button" class="btn-auto-detect" onclick="detectAvailableModels()">
                        <i class="fas fa-search"></i> 測試連線並自動選擇模型
                    </button>
                    <div id="detectStatus" style="font-size: 0.85rem; color: #666; margin-top: 5px;"></div>
                </div>

                <button class="btn-analyze" onclick="startAnalysis()" id="analyzeBtn">
                    <i class="fas fa-magic"></i> 開始 AI 初步分析
                </button>
            </div>

            <div class="result-panel" id="textResultPanel" style="display: none;">
                <h3 style="margin-top:0; color:var(--primary-brown);">2. 初步分析建議</h3>
                <div class="result-card"><div class="result-title"><i class="fas fa-tag"></i> 劇本類型定位</div><div class="result-content" id="res-genre">正在分析...</div></div>
                <div class="result-card"><div class="result-title"><i class="fas fa-user-tie"></i> 潛在投資對象</div><div class="result-content" id="res-investor">正在分析...</div></div>
                <div class="result-card"><div class="result-title"><i class="fas fa-lightbulb"></i> 劇本優化建議</div><div class="result-content" id="res-suggestion">正在分析...</div></div>
            </div>
        </div>

        <div class="charts-container" id="chartResultPanel" style="display: none;">
            <div class="chart-box full-width">
                <h3 style="text-align:center; color:var(--primary-brown);">3. 評分視覺總覽</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div style="width: 400px; height: 400px;"><canvas id="radarChart"></canvas></div>
                    <div style="width: 400px; height: 400px;"><canvas id="barChart"></canvas></div>
                </div>
            </div>
            <div class="chart-box full-width">
                <h3 style="text-align:center; color:var(--primary-brown);">4. 世界票房與受眾預測</h3>
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="font-size: 1.2rem; color: #555;">全球總票房預估：</span>
                    <span id="global-revenue" style="font-size: 2rem; color: #C5A065; font-weight: bold;">$0</span>
                </div>
                <div class="world-box-office" id="continent-container"></div>
            </div>
        </div>
    </main>

    <script>
        const CONFIG = {
            useMockData: true,
            baseUrl: "https://generativelanguage.googleapis.com/v1beta/models/"
        };

        let radarChartInstance = null;
        let barChartInstance = null;

        // 監聽模型選擇
        document.getElementById('modelSelect').addEventListener('change', function() {
            var customInput = document.getElementById('customModelInput');
            if (this.value === 'custom') {
                customInput.style.display = 'block';
                customInput.value = '';
            } else {
                customInput.style.display = 'none';
            }
        });

        // ==========================================
        //  自動偵測模型功能 (新增)
        // ==========================================
        async function detectAvailableModels() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const statusDiv = document.getElementById('detectStatus');
            
            if (!key) { statusDiv.innerHTML = "<span style='color:red'>請先輸入 API Key</span>"; return; }
            statusDiv.innerHTML = "<i class='fas fa-spinner fa-spin'></i> 正在測試 Key 與模型權限...";

            try {
                const response = await fetch(`${CONFIG.baseUrl}?key=${key}`);
                const data = await response.json();

                if (data.models) {
                    // 過濾出 generateContent 支援的模型
                    const supported = data.models
                        .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));
                    
                    statusDiv.innerHTML = `<span style='color:green'>✅ 測試成功！您的 Key 有效。</span>`;
                    
                    // 優先選擇 gemini-2.5-flash 或列表中的第一個
                    let bestModel = supported.find(m => m.includes("gemini-2.5-flash")) || 
                                    supported.find(m => m.includes("gemini-1.5-flash")) || 
                                    supported[0];
                                    
                    alert(`檢測成功！\n\n您的 Key 支援以下模型：\n${supported.join(", ")}\n\n已自動為您選擇：${bestModel}`);
                    
                    // 自動更新選單
                    const select = document.getElementById('modelSelect');
                    if ([...select.options].some(o => o.value === bestModel)) {
                        select.value = bestModel;
                    } else {
                        select.value = 'custom';
                        document.getElementById('customModelInput').style.display = 'block';
                        document.getElementById('customModelInput').value = bestModel;
                    }
                } else {
                    statusDiv.innerHTML = "<span style='color:red'>❌ Key 有效但找不到模型列表。</span>";
                }
            } catch (e) {
                statusDiv.innerHTML = `<span style='color:red'>❌ 連線失敗: ${e.message}</span>`;
            }
        }

        // ==========================================
        //  核心分析功能
        // ==========================================
        async function startAnalysis() {
            const scriptText = document.getElementById('scriptInput').value;
            const userKey = document.getElementById('apiKeyInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            
            let selectedModel = document.getElementById('modelSelect').value;
            if (selectedModel === 'custom') {
                selectedModel = document.getElementById('customModelInput').value.trim();
                if (!selectedModel) { alert("請輸入自訂模型名稱"); return; }
            }

            if (!scriptText) { alert("請先輸入劇本內容！"); return; }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析運算中...';
            btn.classList.add('loading');
            
            let resultData;
            try {
                if (userKey) {
                    console.log(`正在呼叫 API，使用模型: ${selectedModel}`);
                    resultData = await callGeminiAPI(scriptText, userKey, selectedModel);
                } else {
                    await new Promise(r => setTimeout(r, 1500)); 
                    resultData = getMockData();
                }
                
                renderResults(resultData);
                document.getElementById('textResultPanel').style.display = 'flex';
                document.getElementById('chartResultPanel').style.display = 'grid';
                document.getElementById('textResultPanel').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(error);
                alert("API 錯誤：\n" + error.message + "\n\n建議點擊「測試連線」按鈕來檢查 Key 與模型設定。");
            } finally {
                btn.innerHTML = '<i class="fas fa-magic"></i> 重新分析';
                btn.classList.remove('loading');
            }
        }

        // 真實 API 呼叫
        async function callGeminiAPI(script, key, modelName) {
            const prompt = `
                請扮演專業電影分析師，針對以下劇本內容進行分析。
                請務必只回傳純 JSON 格式，不要有 markdown 標記 (不要有 \`\`\`json )。
                
                JSON 結構如下：
                {
                    "genre": "劇本類型",
                    "investors": "3個適合的潛在投資方",
                    "suggestions": "3點具體劇本建議",
                    "radar": [劇情分數, 角色分數, 節奏分數, 商業潛力, 創意分數] (填入1-10的數字),
                    "bar": [結構完整度, 情感張力, 市場契合度, 預算可行性, 對白品質] (填入1-100的數字),
                    "global_box_office": "預估金額",
                    "continents": [
                        {"name": "北美", "revenue": "金額", "age": "主要年齡層"},
                        {"name": "歐洲", "revenue": "金額", "age": "主要年齡層"},
                        {"name": "亞洲", "revenue": "金額", "age": "主要年齡層"},
                        {"name": "南美", "revenue": "金額", "age": "主要年齡層"},
                        {"name": "其他", "revenue": "金額", "age": "主要年齡層"}
                    ]
                }

                劇本內容：
                ${script.substring(0, 2000)}
            `;

            const apiUrl = `${CONFIG.baseUrl}${modelName}:generateContent?key=${key}`;

            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            
            if (data.error) {
                // 如果是 404 Not Found，通常是模型名稱錯了
                if (data.error.code === 404) {
                    throw new Error(`找不到模型 "${modelName}"。請嘗試按「測試連線」來選擇正確的模型名稱。`);
                }
                throw new Error(`${data.error.message}`);
            }
            
            if (!data.candidates || !data.candidates[0].content) {
                throw new Error("API 回傳格式異常，請重試");
            }

            let jsonString = data.candidates[0].content.parts[0].text;
            jsonString = jsonString.replace(/```json/g, "").replace(/```/g, "").trim();
            return JSON.parse(jsonString);
        }

        // 模擬數據
        function getMockData() {
            return {
                genre: "科幻 / 懸疑驚悚",
                investors: "Netflix 原創內容部、華納兄弟、騰訊影業",
                suggestions: "1. 開場節奏稍慢，建議在前五分鐘加入視覺鉤子。\n2. 主角動機不夠強烈，建議增加回憶片段強化情感。\n3. 對白過於文藝，建議修改得更口語化。",
                radar: [8, 7, 6, 9, 8],
                bar: [85, 70, 92, 65, 78],
                global_box_office: "1.2 億 USD",
                continents: [
                    { name: "北美", revenue: "4,500 萬", age: "18-35 歲" },
                    { name: "歐洲", revenue: "3,000 萬", age: "25-45 歲" },
                    { name: "亞洲", revenue: "3,500 萬", age: "18-30 歲" },
                    { name: "南美", revenue: "800 萬", age: "20-40 歲" },
                    { name: "其他", revenue: "200 萬", age: "全齡" }
                ]
            };
        }

        // 渲染畫面
        function renderResults(data) {
            document.getElementById('res-genre').innerText = data.genre;
            document.getElementById('res-investor').innerText = data.investors;
            document.getElementById('res-suggestion').innerText = data.suggestions;
            document.getElementById('global-revenue').innerText = data.global_box_office;

            const contContainer = document.getElementById('continent-container');
            contContainer.innerHTML = '';
            data.continents.forEach(c => {
                contContainer.innerHTML += `
                    <div class="continent-card">
                        <span class="cont-name">${c.name}</span>
                        <span class="cont-money">${c.revenue}</span>
                        <span class="cont-age"><i class="fas fa-users"></i> ${c.age}</span>
                    </div>
                `;
            });
            drawCharts(data.radar, data.bar);
        }

        function drawCharts(radarData, barData) {
            if (radarChartInstance) radarChartInstance.destroy();
            if (barChartInstance) barChartInstance.destroy();

            const ctxRadar = document.getElementById('radarChart').getContext('2d');
            radarChartInstance = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['劇情深度', '角色塑造', '敘事節奏', '商業潛力', '創意原創'],
                    datasets: [{
                        label: '本劇本評分',
                        data: radarData,
                        backgroundColor: 'rgba(197, 160, 101, 0.2)',
                        borderColor: 'rgba(197, 160, 101, 1)',
                        pointBackgroundColor: 'rgba(197, 160, 101, 1)',
                        borderWidth: 2
                    }]
                },
                options: { scales: { r: { min: 0, max: 10, ticks: { display: false } } } }
            });

            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['結構完整度', '情感張力', '市場契合度', '預算可行性', '對白品質'],
                    datasets: [{
                        label: '細項指標 (滿分100)',
                        data: barData,
                        backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 } } }
            });
        }

        // --- 通用 UI 與登入邏輯 ---
        window.onload = function() { if (localStorage.getItem("sata_login") === "true") { updateHeaderToLoggedIn(); } }
        function toggleNav() { var s=document.getElementById("mySidebar");var o=document.getElementById("overlay");if(s.style.left==="0px"){s.style.left="-250px";o.style.display="none";}else{s.style.left="0px";o.style.display="block";} }
        function toggleLoginModal() { var m=document.getElementById("loginModal");m.style.display=(m.style.display==="flex")?"none":"flex"; }
        function toggleMemberModal() { var m=document.getElementById("memberModal");m.style.display=(m.style.display==="flex")?"none":"flex";if(m.style.display==="flex")renderMemberTable(); }
        function performLogin() { var u=document.getElementById("username").value;var p=document.getElementById("password").value;if(u==="123456"&&p==="123456"){localStorage.setItem("sata_login","true");toggleLoginModal();updateHeaderToLoggedIn();}else{alert("帳號密碼錯誤");} }
        function updateHeaderToLoggedIn() { document.getElementById("headerRightSection").innerHTML=`<span class="member-menu"><a href="javascript:void(0)" class="member-link" onclick="toggleMemberModal()">會員管理</a><span class="divider">|</span><a href="javascript:void(0)" class="member-link" onclick="performLogout()">登出</a></span>`; }
        function performLogout() { if(confirm("確定登出?")){localStorage.removeItem("sata_login");document.getElementById("headerRightSection").innerHTML=`<a href="javascript:void(0)" class="login-btn" onclick="toggleLoginModal()">登入</a>`;document.getElementById("memberModal").style.display="none";} }
        function renderMemberTable() {
            var tbody = document.getElementById("investment-table-body");
            var investments = JSON.parse(localStorage.getItem("sata_investments") || "[]");
            tbody.innerHTML = "";
            if (investments.length === 0) { tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#999;'>尚無投資意願</td></tr>"; return; }
            investments.forEach(item => { tbody.innerHTML += `<tr><td>${item.title}</td><td>${item.type}</td><td><span class="status-tag tag-yes">${item.status}</span></td></tr>`; });
        }
    </script>
</body>
</html>
